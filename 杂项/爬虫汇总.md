- [1. 反爬虫策略与绕过](#1-反爬虫策略与绕过)
  - [1.1. 针对chromedriver的检测与绕过](#11-针对chromedriver的检测与绕过)
    - [1.1.1. UserAgent检测](#111-useragent检测)
    - [1.1.2. Webdriver检测](#112-webdriver检测)
    - [1.1.3. chrome属性检测](#113-chrome属性检测)
    - [1.1.4. Permissions检测](#114-permissions检测)
    - [1.1.5. Plugins长度检测](#115-plugins长度检测)
    - [1.1.6. The Languages检测](#116-the-languages检测)
  - [1.2. 其它](#12-其它)
    - [1.2.1. span+css（限制窗口大小+背景图+图片偏移）+包含数字的SVG](#121-spancss限制窗口大小背景图图片偏移包含数字的svg)
- [2. Chromium相关](#2-chromium相关)
  - [2.1. 解决Chromium “缺少 Google API 密钥”问题](#21-解决chromium-缺少-google-api-密钥问题)
    - [2.1.1. 解决方法一：屏蔽提示（不需要登录Google）](#211-解决方法一屏蔽提示不需要登录google)
    - [2.1.2. 解决方法二：使用公开KEY（登录公开Google）](#212-解决方法二使用公开key登录公开google)
    - [2.1.3. 解决方法三：使用自己的KEY（登录自己的Google）](#213-解决方法三使用自己的key登录自己的google)
- [3. Puppeteer相关](#3-puppeteer相关)
  - [3.1. centos安装运行puppeteer遇到的报错及解决方案](#31-centos安装运行puppeteer遇到的报错及解决方案)
  - [3.2. 中文显示方块乱码](#32-中文显示方块乱码)
- [4. 验证码相关](#4-验证码相关)
  - [4.1. Google验证码（ReCaptcha）](#41-google验证码recaptcha)

# 1. 反爬虫策略与绕过
## 1.1. 针对chromedriver的检测与绕过
### 1.1.1. UserAgent检测
无头模式下的UA会带有HeadlessChrome关键字，例如Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/70.0.3521.2 Safari/537.361，因此可以检查UA中的关键字。
```js
if (/HeadlessChrome/.test(navigator.userAgent)) {
  // headless...
}
//修改UserAgent即可绕过
```

### 1.1.2. Webdriver检测
无头模式下navigator.webdriver为true，因此可以进行如下检测。
```js
// Webdriver Test
if (navigator.webdriver) {
  // headless...
}
//重新设置该属性即可绕过
Object.defineProperty(navigator, 'webdriver', {
    get: () => false,
  });
```
但是说实话这个还是有点问题的，因为用"webdriver" in navigator还是能检测出来。

### 1.1.3. chrome属性检测
在无头模式下window.chrome属性是undefined，而在正常有界面模式下，定义如下。
```js
csi: ƒ ()
embeddedSearch: {searchBox: {…}, newTabPage: {…}}
loadTimes: ƒ ()
app: (...)
runtime: (...)
webstore: (...)
get app: ƒ nativeGetter()
set app: ƒ nativeSetter()
get runtime: ƒ nativeGetter()
set runtime: ƒ nativeSetter()
get webstore: ƒ nativeGetter()
set webstore: ƒ nativeSetter()
```
因此可以进行如下形式检测。
```js
if (!window.chrome || !window.chrome.runtime) {
  // headless...
}
//修改属性即可绕过
window.navigator.chrome = {
    runtime: {},
    // etc.
  };
```

### 1.1.4. Permissions检测
无头模式下Notification.permission与navigator.permissions.query会返回相反的值。
```js
(async () => {
  const permissionStatus = await navigator.permissions.query({ name: 'notifications' });
  if(Notification.permission === 'denied' && permissionStatus.state === 'prompt') {
    // headless
  }
})();
//绕过方式如下
await page.evaluateOnNewDocument(() => {
  const originalQuery = window.navigator.permissions.query;
  return window.navigator.permissions.query = (parameters) => (
    parameters.name === 'notifications' ?
      Promise.resolve({ state: Notification.permission }) :
      originalQuery(parameters)
  );
});
```

### 1.1.5. Plugins长度检测
无头模式下navigator.plugins.length返回0。
```js
if (navigator.plugins.length === 0) {
  // headless
}
//绕过方式如下
Object.defineProperty(navigator, 'plugins', {
    get: () => [1, 2, 3, 4, 5],
  });
```

### 1.1.6. The Languages检测
navigator.languages检测方法
```js
if (!navigator.languages || navigator.languages.length === 0) {
  // headless
}
//绕过方式如下
Object.defineProperty(navigator, 'languages', {
    get: () => ['en-US', 'en'],
  });
```

## 1.2. 其它
### 1.2.1. span+css（限制窗口大小+背景图+图片偏移）+包含数字的SVG
出自大众点评网的人均和用户评论等信息，利用span标签配上css创建一个仅能容下一个数字的小窗口，将包含大量数字的SVG设置为背景，并通过调整图片相对于窗口的偏移来展示出相应的数字
* 数字对应span标签

![span](../photo/SVG_span.jpg)
* span标签对应的css，css的background-image为一张包含大量数字的SVG

![css](../photo/SVG_css.jpg)

绕过：获取CSS文件->获取SVG->分析SVG来获取坐标与数字的对照字典->根据span标签的class值定位到CSS->定位坐标->获取值

# 2. Chromium相关
## 2.1. 解决Chromium “缺少 Google API 密钥”问题
每次打开Chromium，地址栏下方就会提示“缺少Google API密钥，因此Chromium的部分功能将无法使用”。

### 2.1.1. 解决方法一：屏蔽提示（不需要登录Google）
设置环境变量，打开windows的cmd命令提示符，依次输入以下命令：
```cmd
setx GOOGLE_API_KEY "no"
setx GOOGLE_DEFAULT_CLIENT_ID "no"
setx GOOGLE_DEFAULT_CLIENT_SECRET "no"
```
可能需要重启电脑。

### 2.1.2. 解决方法二：使用公开KEY（登录公开Google）
cmd 命令提示符，依次输入以下命令：
```cmd
setx GOOGLE_API_KEY AIzaSyDCNWofwOkYgeS3aBnd901sIJqSS4p3nKc
setx GOOGLE_DEFAULT_CLIENT_ID 752805503192-gigd4quq46757vjupq4rv5oga3sougnp.apps.googleusercontent.com
setx GOOGLE_DEFAULT_CLIENT_SECRET bEbljK3NYvuRBe-zn7UyS4Zy
```
可能需要重启电脑。

### 2.1.3. 解决方法三：使用自己的KEY（登录自己的Google）
* https://cloud.google.com/console
* 创建或选择已有项目 → 左侧边栏 API和服务 → 凭证
* 创建凭证(类型为 “API 密钥”,名称随意, 不使用密钥限制,记住生成的key)
* 再创建一个凭证(类型为 “OAuth 客户端 ID”, 名称随意, 应用类型选择 “其他”, 记住生成的 “客户端 ID” 和 “客户端密钥”)
* 格式填写自己的 API Key
```cmd
setx GOOGLE_API_KEY 生成的API密钥
setx GOOGLE_DEFAULT_CLIENT_ID 生成的客户端ID
setx GOOGLE_DEFAULT_CLIENT_SECRET 生成的客户端密钥
```
可能需要重启电脑。

# 3. Puppeteer相关
## 3.1. centos安装运行puppeteer遇到的报错及解决方案
```bash
报错:/home/work/node_modules/puppeteer/.local-chromium/linux-856583/chrome-linux/chrome: error while loading shared libraries: libatk-1.0.so.0: cannot open shared object file: No such file or directory
解决:yum install atk

报错:/home/work/node_modules/puppeteer/.local-chromium/linux-856583/chrome-linux/chrome: error while loading shared libraries: libatk-bridge-2.0.so.0: cannot open shared object file: No such file or directory
解决:yum install at-spi2-atk

报错:/home/work/node_modules/puppeteer/.local-chromium/linux-856583/chrome-linux/chrome: error while loading shared libraries: libxkbcommon.so.0: cannot open shared object file: No such file or directory
解决:yum install libxkbcommon-x11-devel

报错:/home/work/node_modules/puppeteer/.local-chromium/linux-856583/chrome-linux/chrome: error while loading shared libraries: libXcomposite.so.1: cannot open shared object file: No such file or directory
解决:yum install libXcomposite

报错:/home/work/node_modules/puppeteer/.local-chromium/linux-856583/chrome-linux/chrome: error while loading shared libraries: libgtk-3.so.0: cannot open shared object file: No such file or directory
解决:yum install gtk3

yum install atk at-spi2-atk libxkbcommon-x11-devel libXcomposite gtk3 -y
``` 

## 3.2. 中文显示方块乱码
Linux操作系统对中文的支持问题。
```bash
# 查找文泉驿中文包
sudo yum search wqy
Loaded plugins: fastestmirror, langpacks
Repodata is over 2 weeks old. Install yum-cron? Or run: yum makecache fast
Determining fastest mirrors
======================================================== N/S matched: wqy =========================================================
wqy-microhei-fonts.noarch : Compact Chinese fonts derived from Droid
wqy-unibit-fonts.noarch : WenQuanYi Unibit Bitmap Font
wqy-zenhei-fonts.noarch : WenQuanYi Zen Hei CJK Font
# 安装文泉驿中文包
yum install wqy-microhei-fonts.noarch -y
yum install wqy-unibit-fonts.noarch -y
yum install wqy-zenhei-fonts.noarch -y
```

# 4. 验证码相关
## 4.1. Google验证码（ReCaptcha）
* YesCaptcha
* 2Captcha
