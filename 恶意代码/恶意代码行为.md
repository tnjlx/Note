- [1. 恶意行为](#1-恶意行为)
  - [1.1. 提权](#11-提权)
  - [1.2. 下载器与启动器](#12-下载器与启动器)
  - [1.3. 后门](#13-后门)
  - [1.4. 窃取登录凭证](#14-窃取登录凭证)
  - [1.5. 键盘记录器](#15-键盘记录器)
  - [1.6. 扩散](#16-扩散)
- [2. 隐蔽行为（免杀）](#2-隐蔽行为免杀)
  - [2.1. 加密：代码、数据、网络通信](#21-加密代码数据网络通信)
    - [2.1.1. 加密算法](#211-加密算法)
    - [2.1.2. 识别方法](#212-识别方法)
    - [2.1.3. 识别插件](#213-识别插件)
  - [2.2. 进程注入](#22-进程注入)
  - [2.3. 虚拟机检测与反调试](#23-虚拟机检测与反调试)
  - [2.4. 对抗杀软](#24-对抗杀软)
    - [2.4.1. 杀毒软件的自我保护](#241-杀毒软件的自我保护)
    - [2.4.2. ring0对抗](#242-ring0对抗)
  - [2.5. 其它](#25-其它)
  - [2.6. 无文件攻击](#26-无文件攻击)
    - [2.6.1. 利用恶意文档、恶意脚本](#261-利用恶意文档恶意脚本)
    - [2.6.2. 利用Windows工具直接执行载荷](#262-利用windows工具直接执行载荷)
    - [2.6.3. 利用注册表](#263-利用注册表)
    - [2.6.4. 常驻内存技术](#264-常驻内存技术)
- [3. 权限维持（自启动）](#3-权限维持自启动)
  - [3.1. 开机自启动](#31-开机自启动)
  - [3.2. 用户登录时的自启动](#32-用户登录时的自启动)
  - [3.3. 任务计划程序](#33-任务计划程序)
  - [3.4. WMI](#34-wmi)
  - [3.5. webshell](#35-webshell)
  - [3.6. 自启动服务](#36-自启动服务)
  - [3.7. COM劫持](#37-com劫持)
  - [3.8. Bootkit（引导区劫持）](#38-bootkit引导区劫持)
  - [3.9. 被动进程注入技术](#39-被动进程注入技术)
  - [3.10. 修改或者替换系统的二进制文件，并伪造签名](#310-修改或者替换系统的二进制文件并伪造签名)
- [4. 逆向分析：OPSEC（操作安全性）](#4-逆向分析opsec操作安全性)
# 1. 恶意行为
## 1.1. 提权
* 0day和nday漏洞
* 注入高权限进程
* SeDebugPrivilege直接提权

## 1.2. 下载器与启动器

## 1.3. 后门

## 1.4. 窃取登录凭证
* 转储Windows口令哈希，离线破解
* 发动Pass-the-hash攻击
* GINA即第三方自定义登录方式拦截

## 1.5. 键盘记录器
* 消息Hook
* 内核Rootkit捕获
* 按键状态轮询：使用函数GetAsyncKeyState判断一个按键是按下或者弹起，使用GetForegroundWindow识别当前聚焦的前端窗口

## 1.6. 扩散
* PE文件感染
* 文档文件感染

# 2. 隐蔽行为（免杀）
## 2.1. 加密：代码、数据、网络通信
### 2.1.1. 加密算法
* 简单加密算法：如移位、异或，体积小、开销低、没有复杂加密算法的通用特征
* RC4、IDEA：无常量，体积小，易实现，难以识别
* 编码：简单，可以自定义字符集
* 复杂加密算法：存在识别特征
* 自定义加密：可以通过调用恶意代码中存在的函数来解密

### 2.1.2. 识别方法
* 加密相关库和导入函数
* 密钥
* 加密相关字符串
* 计算文件各个部分的熵值（混乱程度）来找到被加密的部分（会误报图片、音频和压缩数据）

### 2.1.3. 识别插件
* IDA-FindCrypt2、3
* IDA-idaentropy-plugin
* Peid-Krypto ANALyzer(识别能力更强，更容易误报)

## 2.2. 进程注入
见《Windows进程注入》

## 2.3. 虚拟机检测与反调试
[虚拟机检测与反沙箱](../反逆向工程/虚拟机检测与反沙箱.md)

## 2.4. 对抗杀软
### 2.4.1. 杀毒软件的自我保护
* OBOperationRegistration保护：当某些软件使用OpenProcess打开了杀毒软件的进程的时候，会触发这个回调，对打开的句柄进行降权，使得无法通过该句柄进行终结进程和读写内存的操作。有些进程如lsass.exe，csrss.exe，他们拥有具有完全权限的杀软句柄。通过ZwQuerySystemInformation查询伪句柄表，找到我们需要的句柄和lsass.exe的PID后，将shellcode注入lsass.exe，获取句柄然后杀掉杀软进程。Wind10之后有PPL保护，但是PPL保护只保护system.exe，而有句柄的lsass.exe，csrss.exe却没有PPL保护。杀软可以对lsass.exe，csrss.exe等进程中的句柄进行去除权限操作。

### 2.4.2. ring0对抗

通过提权漏洞进入ring0读写内存，进行句柄的权限提升，然后直接关闭杀软进程。杀软会使用VT/SVM来HOOK API比如NtTerminateProcess等内核函数来实现增强版保护（360的晶核保护的原理）。

## 2.5. 其它

* 隐藏API调用：利用PEB动态获取LoadLibrary函数地址，再利用LoadLibrary和GetProcAddress动态获取函数地址
* 动态加载：shellcode存储于数据或者资源段，动态加载

## 2.6. 无文件攻击

### 2.6.1. 利用恶意文档、恶意脚本

* 恶意文档可以携带js、pdf等文件，可以携带漏洞利用代码，还可以执行宏文件。
* 恶意脚本检测难度更高，编写更简单，可以进行代码混淆。

### 2.6.2. 利用Windows工具直接执行载荷

* regsvr32.exe
* rundll32.exe
* certutil.exe
* schtask.exe
* WMI

### 2.6.3. 利用注册表

将恶意代码直接写入注册表

### 2.6.4. 常驻内存技术

# 3. 权限维持（自启动）
## 3.1. 开机自启动
* 注册表项：`HKEY_LOCAL_MACHINE\SOFTWARE\Microft\windows\currentversion\run`
* Startup文件夹

## 3.2. 用户登录时的自启动
* 在注册表路径：`HKCU\Environment\`创建字符串键值：`UserInitMprLogonScript`，键值设置为特定的脚本路径即可
* 修改`HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit`，修改为特定脚本、批处理路径
* 注册表`HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon`下其他表项，甚至可以允许恶意代码在安全模式下加载

## 3.3. 任务计划程序
* schtasks
* at

## 3.4. WMI
WMI提供了一个通过操作系统、网络和企业环境去管理本地或远程计算机的统一接口集。应用程序和脚本语言使用这套接口集去完成任务，而不是直接通过Windows API。参考：https://github.com/mattifestation/WMI_Backdoor。

## 3.5. webshell
在WEB服务器上放置webshell，webshell集合传送门：https://github.com/xl7dev/WebShell

## 3.6. 自启动服务
将自己的恶意可执行文件注册成服务，或者调用系统进程如svchost加载dll文件运行服务（隐蔽性较好），创建服务时最好加入一个已存在的服务组或者覆盖一个无关紧要的服务，新创建服务组容易被探测。

## 3.7. COM劫持
通过修改CLSID下的注册表键值，实现对CAccPropServicesClass和MMDeviceEnumerator劫持，而系统很多正常程序启动时需要调用这两个实例，所以，这就可以用作后门来使用，并且，该方法也能够绕过Autoruns对启动项的检测。参考：
* https://www.gdatasoftware.com/blog/2014/10/23941-com-object-hijacking-the-discreet-way-of-persistence
* Powershell版本的POC：https://github.com/3gstudent/COM-Object-hijacking

## 3.8. Bootkit（引导区劫持）
MBR、UEFI劫持。参考：https://slab.qq.com/news/tech/1308.html。

## 3.9. 被动进程注入技术
通过dll加载顺序劫持等方法使得程序被动加载。详情见[Windows进程注入技术](../恶意代码/Windows进程注入技术.md)

## 3.10. 修改或者替换系统的二进制文件，并伪造签名


# 4. 逆向分析：OPSEC（操作安全性）
* 对网络行为进行调查时，要注意不能让对方发现自己在进行调查
  * 搜索引擎搜索未收录域名时，可能会触发搜索引擎对域名的爬虫工作
  * 单击搜索引擎结果，可能会导致二级域名和后续链接被激活
